# Docker 构建参数传递说明

## 参数传递流程

### 完整流程图
```
build.sh (Shell 脚本)
    ↓ export 变量
    ↓ --build-arg 传递
Dockerfile (ARG 声明)
    ↓ 在 RUN 命令中使用
容器构建过程
```

## 详细说明

### 1. build.sh 中的参数定义

```bash
export BASE_IMAGE=ubuntu:24.04          # Shell 环境变量
export PYTHON_VERSION=3.12.11

docker build \
    --build-arg BASE_IMAGE=${BASE_IMAGE}      # 传递给 Docker
    --build-arg PYTHON_VERSION=${PYTHON_VERSION}
```

**说明**:
- `export` 只是在 shell 中设置环境变量,方便后续引用
- `--build-arg` 才是真正将参数传递给 Docker 的方式
- `${BASE_IMAGE}` 会被 shell 展开为实际值 `ubuntu:24.04`

### 2. Dockerfile 中的参数接收

```dockerfile
ARG BASE_IMAGE              # 声明构建参数(无默认值)
FROM ${BASE_IMAGE}          # 使用参数

ARG PYTHON_VERSION          # 在需要使用前声明
RUN wget Python-${PYTHON_VERSION}.tgz   # 使用参数
```

**关键点**:
- `ARG` 必须在使用前声明
- `ARG` 的作用域有限制(见下文)

## ARG 作用域规则

### 规则 1: FROM 之前的 ARG 只能用于 FROM 指令

```dockerfile
ARG BASE_IMAGE              # ✓ 可以在 FROM 中使用
FROM ${BASE_IMAGE}

RUN echo ${BASE_IMAGE}      # ✗ 这里无法访问,值为空
```

### 规则 2: FROM 之后需要重新声明或声明新的 ARG

```dockerfile
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

ARG PYTHON_VERSION          # ✓ 新的 ARG,可以使用
RUN echo ${PYTHON_VERSION}  # ✓ 正常工作

ARG PYTORCH_VERSION         # ✓ 在另一个 RUN 前声明
RUN pip install torch==${PYTORCH_VERSION}  # ✓ 正常工作
```

## 与最初版本的主要区别

### 最初的问题

**原始 Dockerfile (有问题的版本)**:
```dockerfile
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

ENV NVIDIA_DRIVER_CAPABILITIES ${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}
# 问题: NVIDIA_DRIVER_CAPABILITIES 没有通过 ARG 声明,无法从外部传入

RUN apt update && apt install ...
# 问题: 使用 apt 而不是 apt-get,在脚本中不稳定

ARG PYTHON_VERSION
# 问题: 没有默认值,如果忘记传递会报错

RUN if [ ! $TORCHAUDIO_VERSION ]; then
# 问题: 变量未声明就使用,且条件判断语法不正确
```

### 修改后的版本

**当前 Dockerfile (修复后)**:
```dockerfile
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

ARG NVIDIA_DRIVER_CAPABILITIES=compute,utility    # ✓ 有默认值
ENV NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES}  # ✓ 转为环境变量

# ✓ 兼容 Ubuntu 22.04 和 24.04 的源配置
RUN if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then \
        sed -i 's|...|...|g' /etc/apt/sources.list.d/ubuntu.sources; \
    elif [ -f /etc/apt/sources.list ]; then \
        sed -i 's|...|...|g' /etc/apt/sources.list; \
    fi

# ✓ 使用 apt-get 而不是 apt
# ✓ 添加 --no-install-recommends 减少安装体积
RUN apt-get update && apt-get install -y --no-install-recommends ...

ARG PYTHON_VERSION          # ✓ 在使用前声明

ARG PYTORCH_VERSION         # ✓ 所有参数都在使用前声明
ARG PYTORCH_VERSION_SUFFIX
...

# ✓ 使用正确的条件判断语法
RUN if [ -z "$TORCHAUDIO_VERSION" ]; then \
        TORCHAUDIO=""; \
    else \
        TORCHAUDIO="torchaudio==${TORCHAUDIO_VERSION}${TORCHAUDIO_VERSION_SUFFIX}"; \
    fi && \
    pip install torch==${PYTORCH_VERSION}${PYTORCH_VERSION_SUFFIX} ...
```

## 主要改进点

### 1. **ENV 语法修正**
- **之前**: `ENV NVIDIA_DRIVER_CAPABILITIES ${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}`
- **之后**: 
  ```dockerfile
  ARG NVIDIA_DRIVER_CAPABILITIES=compute,utility
  ENV NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES}
  ```
- **原因**: 新语法更清晰,且支持通过 --build-arg 覆盖

### 2. **apt 源配置兼容性**
- **之前**: 只针对 Ubuntu 24.04 的 DEB822 格式
- **之后**: 自动检测并兼容 Ubuntu 22.04 和 24.04
- **好处**: 同一个 Dockerfile 可以构建不同 Ubuntu 版本的镜像

### 3. **条件判断修正**
- **之前**: `if [ ! $TORCHAUDIO_VERSION ]`
- **之后**: `if [ -z "$TORCHAUDIO_VERSION" ]`
- **原因**: 
  - `-z` 是标准的空字符串检查
  - 加引号避免变量为空时语法错误

### 4. **apt 命令优化**
- **之前**: `apt update && apt install`
- **之后**: `apt-get update && apt-get install --no-install-recommends`
- **好处**: 
  - `apt-get` 更适合脚本使用
  - `--no-install-recommends` 减少镜像体积

### 5. **添加 pip 清华源**
- **新增**: 在安装 Python 后配置 pip 使用清华镜像源
- **好处**: 加速 pip 安装,特别是在中国大陆

### 6. **添加 requirements.txt 安装**
- **新增**: 自动安装项目依赖
- **好处**: 构建的镜像开箱即用

## 如何构建不同版本

### 方法 1: 修改 build.sh
```bash
# 编辑 build.sh,修改参数
export PYTHON_VERSION=3.11.9
export PYTORCH_VERSION=2.3.0
...
```

### 方法 2: 创建多个构建脚本
```bash
# build-py3.11.sh
export PYTHON_VERSION=3.11.9
...

# build-py3.12.sh
export PYTHON_VERSION=3.12.11
...
```

### 方法 3: 直接在命令行传递
```bash
docker build \
    --build-arg BASE_IMAGE=ubuntu:22.04 \
    --build-arg PYTHON_VERSION=3.11.9 \
    -t my-image:tag \
    .
```

## 总结

参数传递的本质:
1. **build.sh**: 定义参数值,通过 `--build-arg` 传递
2. **Dockerfile**: 通过 `ARG` 接收参数,在 `RUN` 中使用
3. **关键**: ARG 必须在使用前声明,且注意作用域限制

主要改进:
1. 修正了 ENV 和条件判断语法
2. 添加了阿里云 apt 源和清华 pip 源
3. 兼容多个 Ubuntu 版本
4. 优化了构建过程和镜像体积
5. 自动安装项目依赖

